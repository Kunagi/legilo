#!/bin/bash -e

if [[ -n $(git status -s) ]]; then
    echo 'git is dirty'
    exit 1
fi

VERSION=`cat src/spa/version.txt`

bin/clean

cp -r resources/spa/* firebase/public/
sed -i -e "s/main\.js/main\.v${VERSION}\.js/g" firebase/public/index.html

date -Iminutes > src/spa/version-time.txt

clojure -A:build-release --config-merge "{:release-version \"v"${VERSION}"\"}"

cd firebase
firebase deploy

cd ..
bin/bump-version
